name: 02. Bank Transport (Vault Archive)

on:
  workflow_run:
    workflows: ["01. Sentinel Scout (Frontline Scan)"] # ç›‘å¬ä¾¦å¯Ÿå…µçš„åå­—
    types:
      - completed

jobs:
  transport_mission:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }} # åªæœ‰ä¾¦å¯ŸæˆåŠŸæ‰è¿è¾“
    permissions:
      contents: write

    steps:
      - name: ğŸ“ Checkout Frontline (Latest Intel)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }} # ç¡®ä¿æ‹‰å–åˆ°ä¾¦å¯Ÿå…µåˆšæäº¤çš„åˆ†æ”¯
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # å‡†å¤‡ç¯å¢ƒï¼šåªä¸ºè¿è¡Œæ¬è¿è„šæœ¬
      - name: ğŸ¦ Checkout Central Bank
        uses: actions/checkout@v4
        with:
          repository: wenfp108/Central-Bank
          token: ${{ secrets.MY_PAT }} # å¿…é¡»ä½¿ç”¨ PAT è®¿é—®ç§æœ‰å¤®è¡Œ
          path: central_bank

      # Phase 1: æ‰§è¡Œæ¬è¿ä¸æ¸…ç†é€»è¾‘
      # æ³¨æ„ï¼šä½ çš„ archive-git-to-bank.js å·²ç»åŒ…å«äº†ç‰©ç†æ–‡ä»¶æ¬è¿å’Œæºæ–‡ä»¶åˆ é™¤é€»è¾‘
      - name: ğŸšš Execute Archive & Purge
        run: node scripts/archive-git-to-bank.js

      # Phase 2: èµ„äº§å…¥åº“ (æ¨é€åˆ°å¤®è¡Œ)
      - name: ğŸ’° Push to Central Bank
        run: |
          cd central_bank
          git config --global user.name 'Banker Bot'
          git config --global user.email 'banker@architect.alpha'
          
          if [[ -n $(git status --porcelain) ]]; then
            git add .
            git commit -m "Vault Deposit: Batch from ${{ github.event.workflow_run.head_commit.message }}"
            git push
          else
            echo "Vault is up to date."
          fi

      # Phase 3: æ¸…ç†æˆ˜åœº (åŒæ­¥å‰çº¿çš„åˆ é™¤æ“ä½œ)
      # è„šæœ¬å·²ç»ç‰©ç†åˆ é™¤äº† data/ ä¸‹çš„æ–‡ä»¶ï¼Œè¿™é‡Œåªéœ€è¦æäº¤è¿™ä¸ªåˆ é™¤çŠ¶æ€
      - name: ğŸ§¹ Sync Cleanup to Frontline
        run: |
          # æ ¸å¿ƒä¿®å¤ï¼šé˜²æ­¢ä¸­å¤®é“¶è¡Œæ–‡ä»¶å¤¹è¢«è¯¯æäº¤åˆ°å‰çº¿
          rm -rf central_bank 
          
          git config --global user.name 'Cleaner Bot'
          git config --global user.email 'cleaner@architect.alpha'
          
          # æäº¤åˆ é™¤æ“ä½œ (git add -u ä¼šå¤„ç†è¢«åˆ é™¤çš„æ–‡ä»¶)
          git add -u data/
          
          # åªæœ‰åœ¨æœ‰ä¸œè¥¿éœ€è¦æ¸…ç†æ—¶æ‰æäº¤
          if ! git diff-index --quiet HEAD; then
            git commit -m "Cleanup: Intel flushed to Central Bank [skip ci]"
            git push
          fi
